import asyncio

import aiohttp

from config_data.config import MY_SECRET_URL, LOGIN_X_UI_PANEL, PASSWORD_X_UI_PANEL, PORT_X_UI
from logger.logging_config import logger

cookies_store = {}
RETRIES = 3
DELAY = 3


async def get_session_cookie(server_ip: str):
    if server_ip in cookies_store:


    url = f"https://{server_ip}:{PORT_X_UI}/{MY_SECRET_URL}/login"
    payload = {
        "username": LOGIN_X_UI_PANEL,
        "password": PASSWORD_X_UI_PANEL
    }
    timeout = aiohttp.ClientTimeout(connect=10, total=30)

    for attempt in range(RETRIES):
        try:
            async with aiohttp.ClientSession(timeout=timeout) as session:
                async with session.post(url, data=payload, ssl=False) as response:
                    if response.status == 200:
                        cookies = response.cookies
                        cookies_store[server_ip] = cookies
                        return cookies
                    else:
                        await logger.error()
                        return None
        except asyncio.TimeoutError:
            await logger.info("Request timed out. Retrying...")
        except aiohttp.ClientError as e:
            await logger.info(f"Error making request: {e}")

        if attempt < RETRIES - 1:
            await logger.info(f"Retrying after {DELAY} seconds...")
            await asyncio.sleep(DELAY)
    await logger.log_error("Error getting session cookie", None)
    return None


async def make_request_with_cookies(server_ip, PORT_X_UI, MY_SECRET_URL):
    cookies = cookies_store.get(server_ip)
    if not cookies:
        print(f"No cookies available for {server_ip}")
        return None

    url = f"https://{server_ip}:{PORT_X_UI}/{MY_SECRET_URL}/panel/"
    timeout = aiohttp.ClientTimeout(connect=10, total=30)

    try:
        async with aiohttp.ClientSession(timeout=timeout) as session:
            async with session.get(url, cookies=cookies, ssl=False) as response:
                print(f"Request to {server_ip} responded with status: {response.status}")
                if response.status == 200:
                    print('тут все гуд')
                    data = await response.text()
                    return data
    except aiohttp.ClientError as e:
        print(f"Request to {server_ip} failed: {e}")

    return None