import asyncio
import json
import random
import secrets
from typing import List, Dict

import aiohttp
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message

from config_data.config import ADMIN_IDS, PORT_X_UI, MY_SECRET_URL
from database.context_manager import DatabaseContextManager
from filters.admin import IsAdmin
from handlers.services.get_session_cookies import get_session_cookie
from logger.logging_config import logger

router = Router()


class VlessKeyUpdater:
    def __init__(self, server_ip: str, server_name: str, base_url: str):
        self.server_ip = server_ip
        self.base_url = base_url
        self.server_name = server_name

    def generate_short_ids(self, count=8):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ shortIds –≤ hex —Ñ–æ—Ä–º–∞—Ç–µ —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã."""
        short_ids = []
        possible_lengths = [2, 4, 6, 8, 10, 12, 14, 16]

        for _ in range(count):
            length = random.choice(possible_lengths)
            short_id = secrets.token_hex(length // 2)
            short_ids.append(short_id)

        return short_ids

    def generate_vless_link(self, client_id, port, short_id, public_key, server_name):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π VLESS URL."""
        return (f"vless://{client_id}@{self.server_ip}:{port}"
                f"?type=tcp&security=reality&pbk={public_key}"
                f"&fp=chrome&sni=github.com&sid={short_id}&flow=xtls-rprx-vision"
                f"#{server_name} - VLESS")

    async def get_all_inbounds(self, session) -> List[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö inbound —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π."""
        try:
            cookies = await get_session_cookie(self.server_ip)
            get_all_url = f"{self.base_url}/api/inbounds/list"

            async with session.get(get_all_url, cookies=cookies, ssl=False) as response:
                if response.status == 200:
                    data = await response.json()
                    if data.get("success"):
                        return data.get("obj", [])
                    else:
                        print(f"‚ùå API Error for {self.server_ip}: {data.get('msg', 'Unknown error')}")
                        return []
                else:
                    print(f"‚ùå Failed to get inbounds from {self.server_ip}: {response.status}")
                    return []

        except Exception as e:
            print(f"‚ùå Error getting inbounds from {self.server_ip}: {e}")
            return []

    def needs_update(self, inbound_data: Dict) -> tuple[bool, List[str]]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —ç—Ç–æ—Ç inbound.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (needs_update, issues_list).
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ VLESS –ø—Ä–æ—Ç–æ–∫–æ–ª
            if inbound_data.get("protocol") != "vless":
                return False, []

            stream_settings = json.loads(inbound_data["streamSettings"])

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ Reality security
            if stream_settings.get("security") != "reality":
                return False, []

            settings = json.loads(inbound_data["settings"])
            reality_settings = stream_settings.get("realitySettings", {})

            issues = []

            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã –≤ clients
            if "clients" in settings:
                for client in settings["clients"]:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º flow
                    current_flow = client.get("flow", "")
                    if current_flow != "xtls-rprx-vision":
                        issues.append(f"Wrong flow: {current_flow}")

            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º Reality –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if reality_settings.get("dest") != "github.com:443":
                issues.append(f"Wrong dest: {reality_settings.get('dest')}")

            server_names = reality_settings.get("serverNames", [])
            if "github.com" not in server_names:
                issues.append(f"Wrong serverNames: {server_names}")

            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º settings –≤–Ω—É—Ç—Ä–∏ realitySettings
            reality_inner_settings = reality_settings.get("settings", {})

            if reality_inner_settings.get("fingerprint") != "chrome":
                issues.append(f"Wrong fingerprint: {reality_inner_settings.get('fingerprint')}")

            if reality_inner_settings.get("spiderX") != "":
                issues.append(f"Wrong spiderX: '{reality_inner_settings.get('spiderX')}'")

            return len(issues) > 0, issues

        except Exception as e:
            print(f"‚ùå Error checking key {inbound_data.get('id')}: {e}")
            return False, []

    async def update_vless_key_prepare(self, session, key_data: Dict) -> tuple[bool, List[Dict]]:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç VLESS –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (success, db_update_data).
        """
        key_id = key_data["id"]
        db_update_data = []

        try:
            # –ü–∞—Ä—Å–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            settings = json.loads(key_data["settings"])
            stream_settings = json.loads(key_data["streamSettings"])
            sniffing = json.loads(key_data["sniffing"])

            changes_made = []

            # ‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if "clients" in settings:
                for client in settings["clients"]:
                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º flow —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
                    current_flow = client.get("flow", "")
                    if current_flow != "xtls-rprx-vision":
                        client["flow"] = "xtls-rprx-vision"
                        changes_made.append(f"Fixed flow: {current_flow} ‚Üí xtls-rprx-vision")

            # ‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º Reality –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if "realitySettings" in stream_settings:
                reality_settings = stream_settings["realitySettings"]

                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º destination
                if reality_settings.get("dest") != "github.com:443":
                    old_dest = reality_settings.get("dest")
                    reality_settings["dest"] = "github.com:443"
                    changes_made.append(f"Fixed dest: {old_dest} ‚Üí github.com:443")

                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º serverNames
                if "github.com" not in reality_settings.get("serverNames", []):
                    reality_settings["serverNames"] = ["github.com", "www.github.com"]
                    changes_made.append("Fixed serverNames ‚Üí github.com")

                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ shortIds
                new_short_ids = self.generate_short_ids()
                reality_settings["shortIds"] = new_short_ids
                changes_made.append("Generated new shortIds")

                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º settings –≤–Ω—É—Ç—Ä–∏ realitySettings
                if "settings" in reality_settings:
                    inner_settings = reality_settings["settings"]

                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º spiderX
                    if inner_settings.get("spiderX") != "":
                        old_spider = inner_settings.get("spiderX")
                        inner_settings["spiderX"] = ""
                        changes_made.append(f"Fixed spiderX: '{old_spider}' ‚Üí ''")

                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º fingerprint
                    if inner_settings.get("fingerprint") != "chrome":
                        old_fp = inner_settings.get("fingerprint")
                        inner_settings["fingerprint"] = "chrome"
                        changes_made.append(f"Fixed fingerprint: {old_fp} ‚Üí chrome")

            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            updated_key_data = key_data.copy()
            updated_key_data["settings"] = json.dumps(settings)
            updated_key_data["streamSettings"] = json.dumps(stream_settings)
            updated_key_data["sniffing"] = json.dumps(sniffing)

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            cookies = await get_session_cookie(self.server_ip)
            update_url = f"{self.base_url}/api/inbounds/update/{key_id}"

            async with session.post(update_url, cookies=cookies, json=updated_key_data, ssl=False) as response:
                if response.status == 200:
                    result = await response.json()
                    if result.get("success"):
                        print(f"‚úÖ Key {key_id} on {self.server_ip} updated: {', '.join(changes_made)}")

                        # ‚úÖ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
                        if "clients" in settings:
                            public_key = reality_settings.get("settings", {}).get("publicKey", "")
                            port = key_data.get("port")

                            for client in settings["clients"]:
                                client_id = client.get("id")
                                client_email = client.get("email")

                                if client_id and client_email:
                                    selected_short_id = random.choice(new_short_ids)
                                    new_vless_url = self.generate_vless_link(
                                        client_id=client_id,
                                        port=port,
                                        short_id=selected_short_id,
                                        public_key=public_key,
                                        server_name=self.server_name
                                    )

                                    # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                                    db_update_data.append({
                                        'key_id': key_id,
                                        'new_url': new_vless_url,
                                        'email': client_email
                                    })

                        return True, db_update_data
                    else:
                        print(
                            f"‚ùå Failed to update key {key_id} on {self.server_ip}: {result.get('msg', 'Unknown error')}")
                        return False, []
                else:
                    error_text = await response.text()
                    print(f"‚ùå HTTP Error updating key {key_id} on {self.server_ip}: {response.status}")
                    return False, []

        except Exception as e:
            print(f"‚ùå Exception updating key {key_id} on {self.server_ip}: {e}")
            return False, []

    async def update_all_vless_keys(self, session_methods) -> tuple[int, int, int, int, str]:
        """
        –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö VLESS –∫–ª—é—á–µ–π.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (updated_count, failed_count, total_vless_keys, db_updated_count, summary_log).
        """
        print(f"üöÄ Starting VLESS keys analysis on {self.server_ip}...")

        summary_log = []
        db_updated_count = 0

        async with aiohttp.ClientSession() as session:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ inbounds
            inbounds = await self.get_all_inbounds(session)

            if not inbounds:
                summary_log.append(f"‚ùå No inbounds found on {self.server_ip}")
                return 0, 0, 0, 0, "\n".join(summary_log)

            # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ VLESS –ø—Ä–æ—Ç–æ–∫–æ–ª
            vless_keys = [inbound for inbound in inbounds if inbound.get("protocol") == "vless"]
            summary_log.append(f"üìã {self.server_ip}: Found {len(vless_keys)} VLESS keys")

            if not vless_keys:
                return 0, 0, 0, 0, "\n".join(summary_log)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ –∫–ª—é—á–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
            keys_to_update = []
            problem_summary = {}

            for key_data in vless_keys:
                needs_update, issues = self.needs_update(key_data)
                if needs_update:
                    keys_to_update.append(key_data)
                    for issue in issues:
                        problem_type = issue.split(':')[0]
                        problem_summary[problem_type] = problem_summary.get(problem_type, 0) + 1

            if problem_summary:
                summary_log.append(f"üîß {self.server_ip}: {len(keys_to_update)} keys need updates:")
                for problem, count in problem_summary.items():
                    summary_log.append(f"   ‚Ä¢ {problem}: {count} keys")

            if not keys_to_update:
                summary_log.append(f"‚úÖ {self.server_ip}: All VLESS keys are properly configured!")
                return 0, 0, len(vless_keys), 0, "\n".join(summary_log)

            # ‚úÖ –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ë–î –¥–ª—è batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            db_updates = []
            updated_count = 0
            failed_count = 0

            for i, key_data in enumerate(keys_to_update, 1):
                print(f"üìù Updating key {i}/{len(keys_to_update)} (ID: {key_data['id']}) on {self.server_ip}")

                # ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –∏ —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ë–î
                success, update_data = await self.update_vless_key_prepare(session, key_data)
                if success:
                    updated_count += 1
                    db_updates.extend(update_data)  # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                else:
                    failed_count += 1

                await asyncio.sleep(0.3)

            # ‚úÖ Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –≤ –∫–æ–Ω—Ü–µ
            for update_item in db_updates:
                try:
                    await session_methods.keys.update_key_by_key_id(
                        key_id=update_item['key_id'],
                        key=update_item['new_url'],
                        email=update_item['email']
                    )
                    db_updated_count += 1
                    print(f"‚úÖ Updated key in DB for {update_item['email']} (key_id: {update_item['key_id']})")
                except Exception as db_e:
                    print(f"‚ùå Failed to update key in DB for {update_item['email']}: {db_e}")

            summary_log.append(
                f"üéâ {self.server_ip}: Updated {updated_count} inbounds, {db_updated_count} DB keys, Failed {failed_count}")
            return updated_count, failed_count, len(vless_keys), db_updated_count, "\n".join(summary_log)


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞
@router.message(Command(commands="update_vless_keys"), IsAdmin(ADMIN_IDS))
async def update_vless_keys_command(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö VLESS –∫–ª—é—á–µ–π –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö."""

    await message.answer("üöÄ –ó–∞–ø—É—Å–∫–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ VLESS –∫–ª—é—á–µ–π –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö...")

    async with DatabaseContextManager() as session_methods:
        try:
            servers = await session_methods.servers.get_all_servers()

            if not servers:
                await message.answer("‚ùå –°–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
                return

            total_updated = 0
            total_failed = 0
            total_vless_keys = 0
            total_db_updated = 0
            processed_servers = 0

            # ‚úÖ –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ª–æ–≥–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            all_logs = []

            for server in servers:
                try:
                    print(f"Processing server: {server.server_ip}")

                    base_url = f"https://{server.server_ip}:{PORT_X_UI}/{MY_SECRET_URL}/panel"

                    updater = VlessKeyUpdater(server.server_ip, server.name, base_url)

                    # ‚úÖ –°–æ–∑–¥–∞–µ–º savepoint –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
                    savepoint = await session_methods.session.begin_nested()

                    try:
                        updated, failed, total_keys, db_updated, server_log = await updater.update_all_vless_keys(
                            session_methods)

                        total_updated += updated
                        total_failed += failed
                        total_vless_keys += total_keys
                        total_db_updated += db_updated
                        processed_servers += 1

                        # –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
                        all_logs.append(server_log)

                        # ‚úÖ –ö–æ–º–º–∏—Ç–∏–º savepoint –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
                        await savepoint.commit()
                        print(f"‚úÖ Committed changes for server {server.server_ip}")

                    except Exception as server_e:
                        # ‚úÖ –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
                        await savepoint.rollback()
                        error_msg = f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ {server.server_ip}: {str(server_e)[:100]}"
                        print(error_msg)
                        all_logs.append(error_msg)
                        continue

                except Exception as e:
                    error_msg = f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ {server.server_ip}: {str(e)[:100]}"
                    print(error_msg)
                    all_logs.append(error_msg)
                    continue

            # ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π commit –≤—Å–µ—Ö —É—Å–ø–µ—à–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            await session_methods.session.commit()
            print("‚úÖ Final commit completed")

            # ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
            report = (
                f"üéâ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ VLESS –∫–ª—é—á–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!**\n\n"
                f"üìä **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n"
                f"‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–≤: {processed_servers}\n"
                f"‚Ä¢ –ù–∞–π–¥–µ–Ω–æ VLESS –∫–ª—é—á–µ–π: {total_vless_keys}\n"
                f"‚Ä¢ ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö: {total_updated}\n"
                f"‚Ä¢ ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –ë–î: {total_db_updated}\n"
                f"‚Ä¢ ‚ùå –û—à–∏–±–æ–∫: {total_failed}\n\n"
                f"üìã **–î–µ—Ç–∞–ª–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º:**\n"
                f"{chr(10).join(all_logs)}"
            )

            # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if len(report) > 4000:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                short_report = (
                    f"üéâ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ VLESS –∫–ª—é—á–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!**\n\n"
                    f"üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n"
                    f"‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–≤: {processed_servers}\n"
                    f"‚Ä¢ –ù–∞–π–¥–µ–Ω–æ VLESS –∫–ª—é—á–µ–π: {total_vless_keys}\n"
                    f"‚Ä¢ ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö: {total_updated}\n"
                    f"‚Ä¢ ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –ë–î: {total_db_updated}\n"
                    f"‚Ä¢ ‚ùå –û—à–∏–±–æ–∫: {total_failed}"
                )
                await message.answer(short_report)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if total_updated > 0 or total_failed > 0:
                    details = f"üìã **–î–µ—Ç–∞–ª–∏:**\n{chr(10).join(all_logs[:5])}"  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 —Å–µ—Ä–≤–µ—Ä–æ–≤
                    if len(details) < 4000:
                        await message.answer(details)
            else:
                await message.answer(report)

            # ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –ª–æ–≥–∏
            await logger.log_info(
                f"VLESS keys update completed: {total_updated} servers updated, {total_db_updated} DB keys updated, {total_failed} failed on {processed_servers} servers")

        except Exception as e:
            # ‚úÖ –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
            await session_methods.session.rollback()
            await logger.log_error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ VLESS –∫–ª—é—á–µ–π", e)
            await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π VLESS.")