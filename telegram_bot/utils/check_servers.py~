import asyncio
from datetime import datetime, timedelta

from aiogram import Bot, Router
from aiogram.client.session import aiohttp
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

from config_data.config import PORT_X_UI, MY_SECRET_URL
from database.context_manager import DatabaseContextManager
from handlers.services.get_session_cookies import get_session_cookie
from keyboards.kb_inline import ServerCallbackData
from logger.logging_config import logger

notification_dict = {}

router = Router()


async def ping_servers(bot: Bot):
    while True:
        async with DatabaseContextManager() as session_methods:
            servers = []
            user_subs = []
            try:
                servers = await session_methods.servers.get_all_servers()
                user_subs = await session_methods.subscription.get_subs()
            except Exception as e:
                await logger.log_error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ð·ÑÑ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð², Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²", e)

        for server in servers:
            if server.hidden == 1:
                continue

            reachable = await get_session_cookie(server.server_ip)
            if reachable:
                if server.server_ip in notification_dict:
                    del notification_dict[server.server_ip]
            else:
                button = [InlineKeyboardButton(
                    text="Ð’Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€",
                    callback_data=ServerCallbackData(
                        action='disable',
                        server_ip=server.server_ip).pack()
                )]
                keyboard = InlineKeyboardMarkup(inline_keyboard=[button])
                await logger.log_error(
                    message=f'Ð¡ÐµÑ€Ð²ÐµÑ€: {server.server_ip}\n'
                            f'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ: {server.name}',
                    error='âš ï¸ÐÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ â€¼',
                    keyboard=keyboard
                )
                if server.server_ip not in notification_dict:
                    notification_dict[server.server_ip] = {}
                #
                # for sub in user_subs:
                #     if server.server_ip in sub.key:
                #         user_id = sub.user_id
                #         last_notified = notification_dict[server.server_ip].get(user_id)
                #         if not last_notified or datetime.now() - last_notified > timedelta(minutes=30):
                #             try:
                #                 await bot.send_message(
                #                     chat_id=user_id,
                #                     text=f"âš ï¸ Ð¡ÐµÑ€Ð²ÐµÑ€ {server.name} Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½! âš ï¸\n\n"
                #                          "â„¹ï¸ ÐœÑ‹ Ð·Ð°Ð¼ÐµÑ‚Ð¸Ð»Ð¸, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð² Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐµ. "
                #                          "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ ÑƒÑÐ»ÑƒÐ³Ð°Ð¼Ð¸. ðŸ™\n\n"
                #                          "ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° MaskNetVPN ÑƒÐ¶Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð°Ð´ ÑƒÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹! ðŸ’ªðŸ”§\n\n"
                #                          "Ð‘Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð¸Ð¼ Ð²Ð°Ñ Ð·Ð° Ñ‚ÐµÑ€Ð¿ÐµÐ½Ð¸Ðµ Ð¸ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ! ðŸ’š"
                #                 )
                #                 notification_dict[server.server_ip][user_id] = datetime.now()
                #             except Exception as e:
                #                 await logger.log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ {user_id}", e)

        current_time = datetime.now()
        for server_ip in list(notification_dict.keys()):
            for user_id in list(notification_dict[server_ip].keys()):
                if current_time - notification_dict[server_ip][user_id] > timedelta(minutes=30):
                    del notification_dict[server_ip][user_id]
            if not notification_dict[server_ip]:
                del notification_dict[server_ip]

        await asyncio.sleep(180)
