# .github/workflows/ci-cd.yml
name: CI/CD –¥–ª—è SkyDragon

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Notify start of deployment
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GIT_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          GIT_COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          GIT_COMMIT_DATE: ${{ github.event.head_commit.timestamp }}
          GIT_COMMIT_TYPE: ${{ github.event_name }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d parse_mode=MarkdownV2 \
          -d text="*üöÄ –î–µ–ø–ª–æ–π –Ω–∞—á–∞—Ç*%0A%0A\
          \`\`\`\
          üí¨ –ö–æ–º–º–∏—Ç: ${GIT_COMMIT_MESSAGE//-/\\-}%0A\
          üë§ –ê–≤—Ç–æ—Ä: ${GIT_COMMIT_AUTHOR//-/\\-}%0A\
          üìÖ –î–∞—Ç–∞: ${GIT_COMMIT_DATE//-/\\-}%0A\
          üì¶ –¢–∏–ø —Å–æ–±—ã—Ç–∏—è: ${GIT_COMMIT_TYPE//-/\\-}%0A\
          \`\`\`"

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /root/SkyDragon-VPN
            git pull origin main
            docker-compose down
            docker-compose up -d --build

      - name: Notify end of deployment
        if: success()  # –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–ø–ª–æ–π –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d parse_mode=MarkdownV2 \
          -d text="*‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ\\!*"

      - name: Notify deployment failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d parse_mode=MarkdownV2 \
          -d text="*‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è\\!*%0A–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
